trigger:
- main

variables:
  terraformVersion: '1.6.6'
  devDir: 'Environments/Dev'
  prodDir: 'Environments/Prod'
  infracostApiKey: $(INFRACOST_API_KEY)

stages:

##################################################
# STAGE 1: SAST + CODE QUALITY
##################################################
- stage: SAST_Code_Quality
  displayName: "SAST & Code Quality"
  jobs:
  - job: sast
    pool:
      vmImage: ubuntu-latest
    steps:
    - checkout: self

    # SonarQube
    - task: SonarQubePrepare@5
      inputs:
        SonarQube: 'SonarQube-Service-Connection'
        scannerMode: 'CLI'
        configMode: 'manual'
        cliProjectKey: 'terraform-micro-infra'
        cliSources: '.'

    - task: SonarQubeAnalyze@5
    - task: SonarQubePublish@5
      inputs:
        pollingTimeoutSec: '300'

    # tfsec
    - script: |
        curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
        tfsec .
      displayName: "tfsec Scan"

    # checkov
    - script: |
        pip install checkov
        checkov -d .
      displayName: "Checkov Scan"

##################################################
# STAGE 2: TERRAFORM VALIDATE + PLAN + COST
##################################################
- stage: Terraform_Validate_Plan
  displayName: "Terraform Validate, Plan & Infracost"
  dependsOn: SAST_Code_Quality
  jobs:
  - job: terraform
    pool:
      vmImage: ubuntu-latest
    steps:
    - checkout: self

    # Terraform Init (Assistant)
    - task: TerraformTaskV4@4
      displayName: "Terraform Init (DEV)"
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: $(devDir)
        backendServiceArm: 'AzureRM-Service-Connection'
        backendAzureRmResourceGroupName: 'tfstate-rg'
        backendAzureRmStorageAccountName: 'tfstateaccount'
        backendAzureRmContainerName: 'tfstate'
        backendAzureRmKey: 'dev.tfstate'

    # Terraform Validate
    - task: TerraformTaskV4@4
      displayName: "Terraform Validate (DEV)"
      inputs:
        provider: 'azurerm'
        command: 'validate'
        workingDirectory: $(devDir)

    # Terraform Plan
    - task: TerraformTaskV4@4
      displayName: "Terraform Plan (DEV)"
      inputs:
        provider: 'azurerm'
        command: 'plan'
        workingDirectory: $(devDir)
        environmentServiceNameAzureRM: 'AzureRM-Service-Connection'
        commandOptions: '-out=tfplan'

    # Infracost
    - script: |
        curl -fsSL https://raw.githubusercontent.com/infracost/infracost/master/scripts/install.sh | sh
        infracost breakdown \
          --path $(devDir) \
          --format table
      env:
        INFRACOST_API_KEY: $(infracostApiKey)
      displayName: "Infracost Cost Estimation"

##################################################
# STAGE 3: TERRATEST
##################################################
- stage: Terratest
  displayName: "Terratest Infra Testing"
  dependsOn: Terraform_Validate_Plan
  jobs:
  - job: terratest
    pool:
      vmImage: ubuntu-latest
    steps:
    - checkout: self

    - script: |
        sudo apt update
        sudo apt install -y golang-go
      displayName: "Install Go"

    - script: |
        cd tests/terratest
        go mod init terratest || true
        go mod tidy
        go test -v -timeout 30m
      displayName: "Run Terratest"

##################################################
# STAGE 4: PROD APPLY (MANUAL APPROVAL)
##################################################
- stage: Prod_Deploy
  displayName: "Terraform Apply PROD"
  dependsOn: Terratest
  condition: succeeded()

  jobs:
  - deployment: prod_apply
    displayName: "Apply PROD Infra"
    environment: prod   # ðŸ”’ Manual approval yahin se aayega
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self

          # Terraform Init PROD
          - task: TerraformTaskV4@4
            displayName: "Terraform Init (PROD)"
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: $(prodDir)
              backendServiceArm: 'AzureRM-Service-Connection'
              backendAzureRmResourceGroupName: 'tfstate-rg'
              backendAzureRmStorageAccountName: 'tfstateaccount'
              backendAzureRmContainerName: 'tfstate'
              backendAzureRmKey: 'prod.tfstate'

          # Terraform Apply PROD
          - task: TerraformTaskV4@4
            displayName: "Terraform Apply (PROD)"
            inputs:
              provider: 'azurerm'
              command: 'apply'
              workingDirectory: $(prodDir)
              environmentServiceNameAzureRM: 'AzureRM-Service-Connection'
              commandOptions: '-auto-approve'
